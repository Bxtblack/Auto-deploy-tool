name: Release and Assets

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
      - 'V*'

permissions:
  contents: write

jobs:
  build_and_commit:
    if: startsWith(github.ref, 'refs/heads/')
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller

      - name: Build single-file exe with metadata and icon
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $verLine = (Get-Content 'publisher/resources/pyinstaller_version_info.txt' | Select-String 'StringStruct\(u"FileVersion", u"' | Select-Object -First 1).Line
          $version = ($verLine -replace '.*FileVersion", u"','' -replace '".*','')

          python -m PyInstaller --onefile tools/singlefile_launcher.py \
            --name 自动化部署工具 \
            --icon publisher/resources/app_icon.ico \
            --version-file publisher/resources/pyinstaller_version_info.txt \
            --noconsole \
            --workpath publisher/py_work \
            --distpath publisher/pack_output

          $exe = 'publisher/pack_output/自动化部署工具.exe'
          if (!(Test-Path $exe)) { throw "Exe not found: $exe" }

          New-Item -ItemType Directory -Force -Path 'publisher/release' | Out-Null
          $zipPath = "publisher/release/自动化部署工具_v$version.zip"
          Compress-Archive -Path 'publisher/pack_output/*' -DestinationPath $zipPath -Force
          Copy-Item -Force $zipPath ("publisher/release/v$version.zip")

          $sha = (Get-FileHash $exe -Algorithm SHA256).Hash
          $thumb = (Get-Content 'publisher/pack_input/dist/pinned_thumbprint.txt' -TotalCount 1).Trim()
          $meta = @{ product_version=$version; sha256=$sha; signer_thumbprint=$thumb } | ConvertTo-Json -Depth 2
          Set-Content -Path 'publisher/release/release_metadata.json' -Value $meta -Encoding UTF8

          Set-Content -Path 'checksums/自动化部署工具.exe.sha256' -Value $sha -Encoding ASCII

          Write-Output "VERSION=$version`nSHA256=$sha`nZIP=$zipPath"

      - name: Commit and push assets back to repo
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add checksums/自动化部署工具.exe.sha256 publisher/release/v*.zip publisher/release/release_metadata.json publisher/pack_input/dist/pinned_thumbprint.txt
          git commit -m "build: update release assets [skip ci]" || echo "No changes"
          git push

  release_on_push:
    if: startsWith(github.ref, 'refs/heads/')
    needs: build_and_commit
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read version
        id: vars
        shell: pwsh
        run: |
          $verLine = (Get-Content 'publisher/resources/pyinstaller_version_info.txt' | Select-String 'StringStruct\(u"FileVersion", u"' | Select-Object -First 1).Line
          $version = ($verLine -replace '.*FileVersion", u"','' -replace '".*','')
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Release with overwrite
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.vars.outputs.version }}
          name: 自动化部署工具 v${{ steps.vars.outputs.version }}
          body: |
            自动化部署工具（Windows，闭源分发）。支持任务执行、静默参数识别、完整性校验与签名验证。
          allowUpdates: true
          removeArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            publisher/release/v*.zip
            publisher/release/release_metadata.json
            checksums/自动化部署工具.exe.sha256
            publisher/pack_input/dist/pinned_thumbprint.txt

  release_on_tag:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install PyInstaller
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyinstaller

      - name: Build single-file exe with metadata and icon
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $verLine = (Get-Content 'publisher/resources/pyinstaller_version_info.txt' | Select-String 'StringStruct\(u"FileVersion", u"' | Select-Object -First 1).Line
          $version = ($verLine -replace '.*FileVersion", u"','' -replace '".*','')

          python -m PyInstaller --onefile tools/singlefile_launcher.py \
            --name 自动化部署工具 \
            --icon publisher/resources/app_icon.ico \
            --version-file publisher/resources/pyinstaller_version_info.txt \
            --noconsole \
            --workpath publisher/py_work \
            --distpath publisher/pack_output

          $exe = 'publisher/pack_output/自动化部署工具.exe'
          if (!(Test-Path $exe)) { throw "Exe not found: $exe" }

          New-Item -ItemType Directory -Force -Path 'publisher/release' | Out-Null
          $zipPath = "publisher/release/自动化部署工具_v$version.zip"
          Compress-Archive -Path 'publisher/pack_output/*' -DestinationPath $zipPath -Force
          Copy-Item -Force $zipPath ("publisher/release/v$version.zip")

          $sha = (Get-FileHash $exe -Algorithm SHA256).Hash
          $thumb = (Get-Content 'publisher/pack_input/dist/pinned_thumbprint.txt' -TotalCount 1).Trim()
          $meta = @{ product_version=$version; sha256=$sha; signer_thumbprint=$thumb } | ConvertTo-Json -Depth 2
          Set-Content -Path 'publisher/release/release_metadata.json' -Value $meta -Encoding UTF8

          Set-Content -Path 'checksums/自动化部署工具.exe.sha256' -Value $sha -Encoding ASCII

          Write-Output "VERSION=$version`nSHA256=$sha`nZIP=$zipPath"

      - name: Release with overwrite
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: 自动化部署工具 ${{ github.ref_name }}
          body: |
            自动化部署工具（Windows，闭源分发）。支持任务执行、静默参数识别、完整性校验与签名验证。
          allowUpdates: true
          removeArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            publisher/release/v*.zip
            publisher/release/release_metadata.json
            checksums/自动化部署工具.exe.sha256
            publisher/pack_input/dist/pinned_thumbprint.txt
